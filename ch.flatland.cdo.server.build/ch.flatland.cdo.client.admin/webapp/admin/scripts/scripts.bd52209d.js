"use strict";angular.module("Authentication",[]),angular.module("cdoWebApp",["Authentication","ngAnimate","ngCookies","ngResource","ui.bootstrap","ui.router","ngSanitize","ngTouch","ngJsTree","toaster","naif.base64"]).filter("highlight",["$sce",function(a){return function(b,c){return c&&(b=b.replace(new RegExp("("+c+")","gi"),'<span class="highlighted">$1</span>')),a.trustAsHtml(b)}}]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/login"),a.state("login",{url:"/login",controller:"LoginController",templateUrl:"modules/authentication/views/login.html"}).state("repo",{url:"/repo",controller:"RepoCtrl",templateUrl:"views/repo.html"}).state("search",{url:"/search",controller:"SearchCtrl",templateUrl:"views/search.html"}).state("repo.json",{url:"/json"})}]).config(["$httpProvider",function(a){a.defaults.cache=!1}]).config(["$httpProvider",function(a){a.defaults.withCredentials=!0}]).config(["$logProvider",function(a){a.debugEnabled(!0)}]).run(["$rootScope","$location","$cookieStore","$http",function(a,b,c,d){a.globals=c.get("globals")||{},a.globals.currentUser&&(d.defaults.headers.common.Authorization="Basic "+a.globals.currentUser.authdata),a.$on("$locationChangeStart",function(){"/login"===b.path()||a.globals.currentUser||b.path("/login")}),a.endpoint="http://localhost:8080",a.repository="repo/",a.dateFormat="dd MMMM yyyy - HH:mm:ss"}]),angular.module("cdoWebApp").controller("RepoCtrl",["$rootScope","$scope","$state","$log",function(a,b,c,d){b.tab="repo",a.$on("$stateChangeStart",function(a,c){d.debug("RepoCtrl.$stateChangeStart - received even - "+c.name),b.tab=c.name}),b.$on("objectSelected",function(a,c,e){b.selectedObject=c,d.debug("RepoCtrl.objectSelected - received event - id "+b.selectedObject.id),b.status=e,d.debug(">> set status to scope - "+e.status)}),b.$on("updateSelectedObject",function(a,c){b.selectedObject=c,d.debug("RepoCtrl.updateSelectedObject - received event")})}]),angular.module("cdoWebApp").controller("RepoTreeCtrl",["$rootScope","$scope","$log","TreeModelService","RepoAccessService","ContextService",function(a,b,c,d,e,f){var g=this;g.root={},g.treeData=[];var h=!1;g.isReady=function(){return h},g.treeConfig={core:{multiple:!1,animation:!0,error:function(a){c.error("treeCtrl: error from js tree - "+angular.toJson(a))},themes:{dots:!1,variant:"small"},check_callback:!0,worker:!0},plugins:["sort"]},g.readyCB=function(){c.debug("RepoTreeCtrl.readyCB"),void 0!==a.globals.currentUser&&e.get("/obj/"+a.repository+"eresource.CDOResource/1/references/contents?meta&orderBy=name",function(a,c){200===c?b.$broadcast("repoRootNodeUpdated",a):g.status="Technical problem loading /node"})},g.selectNodeCB=function(a,b){c.debug("RepoTreeCtrl.selectNodeCB - "+b.node.id),(void 0===g.selectedObject||g.selectedObject.id!==b.node.data.id)&&g.setSelectedObject(b.node.data)},g.setSelectedObject=function(a,b){c.debug("RepoTreeCtrl.setSelectedObject - "+a.id);var d=!0;void 0!==b&&(d=b),d&&g.resetStatus(),g.selectedObject=a,g.selectedObject.containments=[],void 0!==g.selectedObject.meta.references&&(g.selectedObject.meta.references.forEach(function(a){a.containment&&(c.debug(">> found containment meta - "+a.feature),g.selectedObject.containments.push(a))}),g.selectedObject.containments.sort(function(a,b){var c=a,d=b;return d>c?-1:c>d?0:1}),g.selectedObject.containment=g.selectedObject.containments[0]),f.setSelectedObject(g.selectedObject._links.self.href,function(a,b){404===b?(g.removeNode(g.selectedObject.id),g.status=b+" - "+a.error.message,f.updateSelectedObject(void 0)):200!==b&&(g.status="Technical problem loading "+g.selectedObject._links.self.href)})},g.indexOfItem=function(a){for(var b=0,c=g.treeData.length;c>b;b++)if(g.treeData[b].id===a.toString())return b;return-1},g.getNode=function(a){var b=g.indexOfItem(a);return b>-1?g.treeData[g.indexOfItem(a)]:void 0},g.removeNode=function(a){c.debug("RepoTreeCtrl.removeNode - id "+a);var b=-1;g.treeData.forEach(function(d){b++,d.id===a.toString()&&(c.debug(">> found node - "+a),g.treeData.splice(b,1))})},g.possibleTypes=function(){var a=[];return void 0!==g.selectedObject&&void 0!==g.selectedObject.meta.references&&(g.selectedObject.meta.references.forEach(function(b){void 0!==g.selectedObject.containment&&b.feature===g.selectedObject.containment.feature&&(b["abstract"]===!1&&b.type&&a.push(b.type),void 0!==b.extendedFrom&&b.extendedFrom.forEach(function(b){a.push(b)}))}),a.sort(function(a,b){var c=a,d=b;return d>c?-1:c>d?1:0}),(void 0===g.selectedObject.objectType||a.indexOf(g.selectedObject.objectType)<=0)&&(g.selectedObject.objectType=a[0])),a},g.addNode=function(){c.debug("RepoTreeCtrl.addNode "+g.selectedObject.objectType+" to "+g.selectedObject.id);var a={type:g.selectedObject.objectType};0===g.selectedObject.objectType.indexOf("eresource.CDOResource")&&(a.attributes={name:"NEW RESOURCE"}),g.dataLoading=!0,e.post(g.selectedObject._links.self.href+"/references/"+g.selectedObject.containment.feature+"?rrefs&meta",a,function(b,c){if(201===c){var e=d.transformObject(b.data,g.selectedObject.id);e.state={selected:!0},g.treeData.push(e),g.addNodeStatus=b.status;var f=g.getNode(g.selectedObject.id);g.treeInstance.jstree("deselect_node",f),g.setSelectedObject(e.data,!1),g.dataLoading=!1}else 409===c?(g.addNodeStatusFailed=c+" - "+b.error.message+" : "+a.attributes.name,g.dataLoading=!1):(g.addNodeStatusFailed="Technical problem post "+g.selectedObject._links.self.href+"/references/"+g.selectedObject.containment.feature,g.dataLoading=!1)})},g.showAddNodeSuccess=function(){return void 0!==g.addNodeStatus&&g.addNodeStatus.revisionDeltas.length>0?!0:!1},g.closeAddNodeSuccess=function(){g.addNodeStatus=void 0},g.closeAddNodeFailed=function(){g.addNodeStatusFailed=void 0},g.deleteNode=function(){c.debug("RepoTreeCtrl.removeNode - "+g.selectedObject.id),g.dataLoading2=!0,e["delete"](g.selectedObject._links.self.href,function(a,b){200===b?(g.removeNode(g.selectedObject.id),f.updateSelectedObject(void 0),g.removeNodeStatus=a.status,g.dataLoading2=!1):409===b?(g.removeNodeStatusFailed=b+" - "+a.error.message,g.dataLoading2=!1):(g.removeNodeStatusFailed="Technical problem delete "+g.selectedObject._links.self.href+"/references/"+g.selectedObject.containment.feature,g.dataLoading2=!1)})},g.showRemoveNodeSuccess=function(){return void 0!==g.removeNodeStatus&&g.removeNodeStatus.revisionDeltas.length>0?!0:!1},g.closeRemoveNodeSuccess=function(){g.removeNodeStatus=void 0},g.closeRemoveNodeFailed=function(){g.removeNodeStatusFailed=void 0},g.applyModelChanges=function(){return c.debug("RepoTreeCtrl.applyModelChanges"),!0},g.beforeOpenNodeCB=function(a,b){c.debug("RepoTreeCtrl.beforeOpenNodeCB - "+b.node.id)},g.resolveChildren=function(a){c.debug(">> resolve childen");var b=a.url+"/references?crefs&meta";e.get(b,function(b,c){if(200===c){var e=d.transformChildren(b.data,a.id);e.forEach(function(a){g.treeData.push(a)}),a.resolved=!0}else 404===c?a.resolved=!0:g.status="Technical problem loading "+a.url})},g.openNodeCB=function(a,b){c.debug("RepoTreeCtrl.openNodeCB - "+b.node.id),g.treeData.forEach(function(a){a.parent.id===b.node.id&&a.resolved===!1&&g.resolveChildren(a)})},b.$on("repoRootNodeUpdated",function(a,b){h=!1,c.debug("RepoTreeCtrl.repoRootNodeUpdated - received event"),g.treeData.length=0,void 0!==b.data&&b.data.reverse().forEach(function(a){var b=d.transformObject(a,"#");g.treeData.push(b),g.resolveChildren(b)}),h=!0}),b.$on("objectSelected",function(a,b){if(g.selectedObject.id!==b.id){var c=g.getNode(g.selectedObject.id);g.treeInstance.jstree("deselect_node",c);var d=g.getNode(b.id);g.treeInstance.jstree("select_node",d)}}),b.$on("updateSelectedObject",function(a,b){c.debug("RepoTreeCtrl.updateSelectedObject - received event");var d={};if(void 0!==b){var e=g.getNode(b.id);d=e.parent;var f=b.label;f.length>60&&(f=f.substring(0,60)+" ..."),"eresource.CDOResourceFolder"===b.type&&(f=b.attributes.name),e.data=b,g.treeInstance.jstree("rename_node",e,f);var h=-1,i=0,j=-1,k=!1;g.treeData.forEach(function(a){h++,a.parent.id===d.id.toString()&&(i++,k!==!0&&(j=h,k=!0),c.debug(">> Found node to resfresh - "+a.text+" "+h))}),c.debug(">> to splice for sort - start - "+j+" size "+i);var l=g.treeData.splice(j,i);l.forEach(function(a){g.treeData.push(a)})}}),g.closeAlert=function(){g.status=void 0},g.resetStatus=function(){g.status=void 0,g.addNodeStatusFailed=void 0,g.addNodeStatus=void 0,g.removeNodeStatus=void 0,g.removeNodeStatusFailed=void 0}}]),angular.module("cdoWebApp").controller("NavCtrl",["$scope","$location",function(a,b){a.isActive=function(a){var c=a===b.path()||a.split("/")[1]===b.path().split("/")[1];return c}}]),angular.module("cdoWebApp").controller("AttributesCtrl",["$scope","$log","RepoAccessService","ContextService",function(a,b,c,d){a.save=function(){var e={};a.selectedObject.meta.attributes.forEach(function(c){var d=a.selectedObject.attributes[c.feature];b.debug("AttributesCtrl check attribute - "+d),void 0===d||null===d||0===d.length?e[c.feature]=null:"ecore.xml.type.Base64Binary"===c.type?(b.debug("Base64 "+d[0].filesize+" "+d[0].base64),e[c.feature]=d[0].base64):e[c.feature]=d}),a.dataLoading=!0,c.put(a.selectedObject._links.self.href+"?rrefs&meta",{attributes:e},function(b,c){200===c?(d.updateSelectedObject(b.data),a.dataLoading=!1,a.status=b.status):409===c?(a.status={},a.status.error=c+" - "+b.error.message+" : "+e.name,a.dataLoading=!1):404===c?(a.status={},a.status.error=c+" - "+b.error.message,a.selectedObject=void 0,a.dataLoading=!1):(a.status={},a.status.error="Technical problem udpdating "+a.selectedObject._links.self.href,a.dataLoading=!1)})},a.closeAlert=function(c,d){b.debug("AttributesCtrl.closeAlert - index "+c),void 0!==c?d.splice(c,1):a.status=void 0},a.showAlertSuccess=function(){return void 0!==a.status&&void 0!==a.status.revisionDeltas&&a.status.revisionDeltas.length>0?!0:!1},a.showAlertDiagnostics=function(){var b=!1;return void 0!==a.status&&void 0!==a.status.diagnostics&&a.status.diagnostics.forEach(function(a){a.diagnostic.forEach(function(a){0===a.feature.indexOf("attributes")&&(b=!0)})}),b},a.$on("objectSelected",function(b,c,d){a.status="INVALID"===d.status?d:void 0}),a.$on("updateSelectedObject",function(c,d){void 0===d&&(a.status=void 0,b.debug("AttributesCtrl.updateSelectedObject - reset status - undefined"))})}]),angular.module("cdoWebApp").controller("ReferencesCtrl",["$rootScope","$scope","$log","$http","CalculateUrlService","RepoAccessService","ContextService",function(a,b,c,d,e,f,g){b.getIcon=function(a){return e.getUrl(a)},b.setNewObject=function(a){g.setSelectedObject(a)},b.refCandidates=function(b,f){var g=e.getUrl("/obj/"+a.repository+f+"?name="+b);return c.debug("ReferencesCtrl.getObjects - "+g),d.get(g).then(function(a){return a.data.data.map(function(a){return a})})},b.newRef=function(a,f){var h=b.selectedObject._links.self.href+"/references/"+f+"/"+a+"?rrefs&meta";c.debug("ReferencesCtrl.newReference - "+h);var i=e.getUrl(h);b.dataLoading=!0,d.put(i).success(function(a){g.updateSelectedObject(a.data),b.dataLoading=!1,b.status=a.status}).error(function(a,c){404===c?(b.status={},b.status.error=c+" - "+a.error.message,b.selectedObject=void 0,b.dataLoading=!1):(b.status={},b.status.error="Technical problem udpdating "+b.selectedObject._links.self.href,b.dataLoading=!1)})},b.removeReference=function(a,d){var e=b.selectedObject._links.self.href+"/references/"+d+"/"+a;c.debug("ReferencesCtrl.removeReference - "+e),b.dataLoading=!0,f["delete"](e+"?rrefs&meta",function(a,c){200===c?(g.updateSelectedObject(a.data),b.dataLoading=!1,b.status=a.status):404===c?(b.status={},b.status.error=c+" - "+a.error.message,b.selectedObject=void 0,b.dataLoading=!1):(b.status={},b.status.error="Technical problem udpdating "+b.selectedObject._links.self.href,b.dataLoading=!1)})},b.closeAlert=function(a,d){c.debug("ReferencesCtrl.closeAlert - index "+a),void 0!==a?d.splice(a,1):b.status=void 0},b.showAlertSuccess=function(){return void 0!==b.status&&void 0!==b.status.revisionDeltas&&b.status.revisionDeltas.length>0?!0:!1},b.showAlertDiagnostics=function(){var a=!1;return void 0!==b.status&&void 0!==b.status.diagnostics&&b.status.diagnostics.forEach(function(b){b.diagnostic.forEach(function(b){0===b.feature.indexOf("references")&&(a=!0)})}),a},b.$on("objectSelected",function(a,c,d){b.status="INVALID"===d.status?d:void 0}),b.$on("updateSelectedObject",function(a,d){void 0===d&&(b.status=void 0,c.debug("ReferencesCtrl.updateSelectedObject - reset status - undefined"))}),b.showObject=function(a,b){return"WRITE"===b.permission&&a.containment===!1?!0:"READ"===b.permission&&void 0!==b.references[a.feature]?!0:!1}}]),angular.module("Authentication").factory("AuthenticationService",["Base64","$http","$cookieStore","$rootScope","CalculateUrlService",function(a,b,c,d,e){var f={};return f.Login=function(c,f,g){b.defaults.headers.common.Authorization="Basic "+a.encode(c+":"+f),b.get(e.getUrl("/obj/"+d.repository+"eresource.CDOResource/1/references/contents?meta&orderBy=name")).success(function(a,b){g(a,b)}).error(function(a,b){a.message="Username or password is incorrect",g(a,b)})},f.SetCredentials=function(e,f){var g=a.encode(e+":"+f);d.globals={currentUser:{username:e,authdata:g}},b.defaults.headers.common.Authorization="Basic "+g,c.put("globals",d.globals)},f.ClearCredentials=function(){d.globals={},c.remove("globals"),b.defaults.headers.common.Authorization="Basic "},f}]).factory("Base64",function(){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(b){var c,d,e,f,g,h="",i="",j="",k=0;do c=b.charCodeAt(k++),d=b.charCodeAt(k++),i=b.charCodeAt(k++),e=c>>2,f=(3&c)<<4|d>>4,g=(15&d)<<2|i>>6,j=63&i,isNaN(d)?g=j=64:isNaN(i)&&(j=64),h=h+a.charAt(e)+a.charAt(f)+a.charAt(g)+a.charAt(j),c=d=i="",e=f=g=j="";while(k<b.length);return h},decode:function(b){var c,d,e,f,g,h="",i="",j="",k=0,l=/[^A-Za-z0-9\+\/\=]/g;l.exec(b)&&window.alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding."),b=b.replace(/[^A-Za-z0-9\+\/\=]/g,"");do e=a.indexOf(b.charAt(k++)),f=a.indexOf(b.charAt(k++)),g=a.indexOf(b.charAt(k++)),j=a.indexOf(b.charAt(k++)),c=e<<2|f>>4,d=(15&f)<<4|g>>2,i=(3&g)<<6|j,h+=String.fromCharCode(c),64!=g&&(h+=String.fromCharCode(d)),64!=j&&(h+=String.fromCharCode(i)),c=d=i="",e=f=g=j="";while(k<b.length);return h}}}),angular.module("Authentication").controller("LoginController",["$scope","$rootScope","$location","$log","toaster","AuthenticationService",function(a,b,c,d,e,f){f.ClearCredentials(),a.rendpoint=b.endpoint,a.login=function(){a.dataLoading=!0,b.endpoint=a.rendpoint,d.debug("Repo Endpoint - "+b.endpoint),f.Login(a.username,a.password,function(d,g){200===g?(e.pop("success","Authentication ok","Welcome "+a.username),b.$broadcast("repoRootNodeUpdated",d),f.SetCredentials(a.username,a.password),c.path("/repo")):(a.error=d.message,a.dataLoading=!1)})},a.closeAlert=function(){a.error=!1}}]),angular.module("cdoWebApp").service("CalculateUrlService",["$rootScope",function(a){var b={};return b.getUrl=function(b){return a.endpoint+b},b}]),angular.module("cdoWebApp").service("RepoAccessService",["$rootScope","$http","$log","CalculateUrlService",function(a,b,c,d){var e={};return e.get=function(e,f){var g=d.getUrl(e);a.update=!0,b.get(g).success(function(b,d){c.debug("RepoAccessService.get - "+g+" - status "+d),f(b,d),a.update=!1}).error(function(b,d){c.debug("RepoAccessService.get - "+g+" - status "+d),f(b,d),a.update=!1})},e.put=function(a,e,f){var g=d.getUrl(a);b.put(g,e).success(function(a,b){c.debug("RepoAccessService.put - "+g+" - status "+b),f(a,b)}).error(function(a,b){c.debug("RepoAccessService.put - "+g+" - status "+b),f(a,b)})},e.post=function(a,e,f){var g=d.getUrl(a);b.post(g,e).success(function(a,b){c.debug("RepoAccessService.post - "+g+" - status "+b),f(a,b)}).error(function(a,b){c.debug("RepoAccessService.post - "+g+" - status "+b),f(a,b)})},e["delete"]=function(a,e){var f=d.getUrl(a);b["delete"](f).success(function(a,b){c.debug("RepoAccessService.delete - "+f+" - status "+b),e(a,b)}).error(function(a,b){c.debug("RepoAccessService.delete - "+f+" - status "+b),e(a,b)})},e}]),angular.module("cdoWebApp").service("TreeModelService",["$log","CalculateUrlService",function(a,b){var c={};return c.transformObject=function(a,c){var d={};if(d.id=a.id.toString(),d.parent={id:c},"eresource.CDOResourceFolder"===a.type)d.text=a.attributes.name;else{var e=a.label;d.text=e.length>30?a.label.substring(0,30)+" ...":a.label}return d.state={opened:!1},d.icon=b.getUrl(a.icon),d.url=a._links.self.href,d.resolved=!1,d.data=a,d.li_attr="READ"===a.permission?{"class":"readpermission"}:{"class":"writepermission"},d},c.transformChildren=function(a,b){var d=[];return a.forEach(function(a){var e=c.transformObject(a,b);d.push(e)}),d.reverse()},c}]),angular.module("cdoWebApp").service("ContextService",["$rootScope","$log","RepoAccessService",function(a,b,c){var d,e=function(e,f){b.debug("LOAD - url "+e),a.update=!0,c.get(e+"?rrefs&crefs&meta",function(c,e){200===e?(d=c.data,b.debug("ContextService.objectedSelected - broadcast event"),void 0!==f&&f(c,e),a.update=!1,a.$broadcast("objectSelected",d,c.status)):(f(c,e),a.update=!1)})},f=function(c){d=c,b.debug("ContextService.updateSelectedObject - broadcast event"),a.$broadcast("updateSelectedObject",d)},g=function(){return d};return{setSelectedObject:e,updateSelectedObject:f,getSelectedObject:g}}]),angular.module("cdoWebApp").directive("objectIdentity",function(){return{restrict:"E",templateUrl:"views/objectidentity.html"}}),angular.module("cdoWebApp").directive("attributesForm",function(){return{restrict:"E",templateUrl:"views/attributesform.html"}}),angular.module("cdoWebApp").directive("markdownEditor",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){b.markdown({savable:!1,autofocus:!1,hideable:!1,onChange:function(a){d.$setViewValue(a.getContent())},onShow:function(b){a.$watch(function(){return d.$modelValue},function(a){a&&b.setContent(a)})}})}}}),angular.module("cdoWebApp").directive("addNode",function(){return{restrict:"E",templateUrl:"views/addnode.html"}}),angular.module("cdoWebApp").directive("removeNode",function(){return{restrict:"E",templateUrl:"views/removenode.html"}}),angular.module("cdoWebApp").directive("referencesForm",function(){return{restrict:"E",templateUrl:"views/referencesform.html"}}),angular.module("cdoWebApp").directive("refLink",function(){return{restrict:"E",templateUrl:"views/reflink.html",scope:{refObject:"=",refFeature:"="}}}),angular.module("cdoWebApp").controller("SearchCtrl",["$rootScope","$scope","$state","$log","RepoAccessService","CalculateUrlService","ContextService",function(a,b,c,d,e,f,g){b.searchLiterals=["by id","by name","by description"],b.searchType=b.searchLiterals[1],b.rowCollection=[],b.search=function(){d.debug("Search "+b.searchType+" "+b.query),b.rowCollection=[];var c="";b.searchType===b.searchLiterals[0]&&(c="ID="+b.query),b.searchType===b.searchLiterals[1]&&(c="name="+b.query),b.searchType===b.searchLiterals[2]&&(c="description="+b.query),e.get("/obj/"+a.repository+"base.FLElement?"+c,function(a,c){if(200===c)for(var d=a.data,e=0;e<d.length;e++){var g=d[e].label;g.length>50&&(d[e].label=g.substring(0,50)+" ..."),d[e].icon=f.getUrl(d[e].icon),b.rowCollection.push(d[e])}})},b.setNewObject=function(a){g.setSelectedObject(a)},b.$on("objectSelected",function(a,c,e){b.selectedObject=c,d.debug("SearchCtrl.objectSelected - received event - id "+b.selectedObject.id),b.status=e,d.debug(">> set status to scope - "+e.status)}),b.$on("updateSelectedObject",function(a,c){b.selectedObject=c,d.debug("SearchCtrl.updateSelectedObject - received event")})}]);